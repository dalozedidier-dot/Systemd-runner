name: Smoke (DDR + E)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pyyaml

      - name: Debug layout
        shell: bash
        run: |
          set -euo pipefail
          echo "PWD=$(pwd)"
          ls -la
          echo "Has harness:"
          test -f 01_tests_multisector/harness.py && echo "OK" || (echo "Missing harness.py" && exit 1)
          echo "Has profiles dir:"
          test -d 00_core/examples/profiles && echo "OK" || (echo "Missing 00_core/examples/profiles" && exit 1)

      - name: Run harness (write results to file)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _ci_out
          python 01_tests_multisector/harness.py \
            --repo-root . \
            --profiles 00_core/examples/profiles \
            --out _ci_out/harness_results.json

      - name: Collect reports if they exist
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _ci_out
          find . -type f \( -name "dd_report.json" -o -name "ddr_report.json" -o -name "e_report.json" \) -print \
            -exec cp -f {} _ci_out/ \; || true

      - name: Summary
        shell: bash
        run: |
          set -euo pipefail
          if [ -f _ci_out/harness_results.json ]; then
            python - <<'PY'
import json
from pathlib import Path

p = Path("_ci_out/harness_results.json")
data = json.loads(p.read_text(encoding="utf-8"))
total = len(data)
ok = sum(1 for r in data if r.get("ok") is True)
fail = total - ok

print(f"Total: {total}")
print(f"OK: {ok}")
print(f"FAIL: {fail}")

summary = []
summary.append("# Smoke DDR + E")
summary.append("")
summary.append(f"- Total: {total}")
summary.append(f"- OK: {ok}")
summary.append(f"- FAIL: {fail}")
Path("_ci_out/summary.md").write_text("\n".join(summary), encoding="utf-8")
PY
            cat _ci_out/summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No harness_results.json found" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: systemd_runner_ci_out
          path: _ci_out/
