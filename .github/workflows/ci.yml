name: Smoke (Systemd-runner)

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (best effort)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          # Si tu as un requirements.txt quelque part, on le prend, sinon on installe le minimum utile.
          if [ -f "requirements.txt" ]; then
            python -m pip install -r requirements.txt
          fi
          if [ -f "01_tests_multisector/requirements.txt" ]; then
            python -m pip install -r 01_tests_multisector/requirements.txt
          fi
          python -m pip install pyyaml

      - name: Debug layout
        shell: bash
        run: |
          set -euo pipefail
          echo "PWD=$(pwd)"
          ls -la
          echo "01_tests_multisector:"
          ls -la 01_tests_multisector || true

      - name: Run harness smoke
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _ci_out

          cd 01_tests_multisector

          # On logge l'aide du CLI (utile en artefact)
          python harness.py --help > ../_ci_out/harness_help.txt 2>&1 || true

          # Auto-détection du dossier profils (le repo peut bouger, donc on cherche)
          PROFILES_DIR="$(python - <<'PY'
from pathlib import Path
import re

root = Path(".").resolve()

candidates = [
    root / "tests" / "profiles",
    root / "profiles",
    root / ".." / "_00_core" / "examples" / "profiles",
    root / ".." / "00_core" / "examples" / "profiles",
]

def has_yaml_profiles(d: Path) -> bool:
    if not d.is_dir():
        return False
    ys = list(d.glob("*.yml")) + list(d.glob("*.yaml"))
    if not ys:
        return False
    # Heuristique: on veut des fichiers qui ressemblent à des profils
    for p in ys[:20]:
        txt = p.read_text(errors="ignore")
        if "profile" in txt or "profile_id" in txt or "id:" in txt:
            return True
    return True

for d in candidates:
    if has_yaml_profiles(d):
        print(d.as_posix())
        raise SystemExit(0)

# Si pas trouvé dans les candidats, on cherche un dossier qui contient le plus de YAML
best_dir = None
best_count = 0
for d in root.rglob("*"):
    if not d.is_dir():
        continue
    ys = list(d.glob("*.yml")) + list(d.glob("*.yaml"))
    if len(ys) > best_count:
        # Vérif rapide qu'on n'est pas juste dans .github/workflows
        if ".github/workflows" in d.as_posix():
            continue
        best_dir = d
        best_count = len(ys)

if best_dir is None or best_count == 0:
    print("")  # vide
else:
    print(best_dir.as_posix())
PY
)"
          echo "PROFILES_DIR=$PROFILES_DIR"

          if [ -z "${PROFILES_DIR}" ]; then
            echo "ERROR: impossible de trouver un dossier de profils YAML."
            echo "Arborescence utile:"
            find . -maxdepth 4 -type d -print
            exit 2
          fi

          # IMPORTANT: --out doit être un FICHIER, pas un dossier.
          python harness.py \
            --repo-root .. \
            --profiles "${PROFILES_DIR}" \
            --out ../_ci_out/harness_results.json \
            2>&1 | tee ../_ci_out/smoke.log

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: systemd_runner_ci_out
          path: _ci_out/
          if-no-files-found: warn
